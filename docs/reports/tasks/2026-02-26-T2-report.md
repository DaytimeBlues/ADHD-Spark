# Task Report: T2 — Fix listenerRef Dependency Safety in useAgentEvents

**Task ID:** T2  
**Date:** 2026-02-26  
**Status:** ✅ Completed  
**Scope:** `spark-adhd/src/hooks/useAgentEvents.ts`  
**Follow-up to:** T1 — Timer Store Selector Refactor

---

## Summary of Changes

Fixed critical bug in `useAgentEvents` hook where `listenerRef` was referenced but never declared, causing runtime errors.

### Key Changes:
1. **Added missing `useRef` initialization:**
   - Added: `const listenerRef = useRef(listener)`
   - This stores the latest listener callback in a mutable ref

2. **Added ref synchronization effect:**
   - Added effect to update `listenerRef.current` whenever `listener` prop changes
   - Ensures the callback always points to the latest function without re-subscribing to events

3. **Preserved stable subscription lifecycle:**
   - The subscription effect still only depends on `[event]`
   - Event bus subscription is not recreated when listener changes
   - Prevents stale closures while maintaining subscription stability

---

## Rationale

The original implementation had a bug where `listenerRef.current` was called inside the subscription callback, but `listenerRef` was never declared with `useRef()`. This would cause a runtime `ReferenceError` when the hook executed.

The fix implements the intended pattern:
- Store the listener in a ref to avoid stale closures
- Update the ref when the listener changes (no-op re-render, no re-subscription)
- The event bus subscription remains stable, only changing when the event type changes

---

## Files Changed

- `src/hooks/useAgentEvents.ts` (only file modified)

---

## Risk Assessment

**Level:** Low

### Potential Risks:
- Ref update effect runs on every listener change (expected behavior)
- Subscription still only re-creates when event changes (stable)

### Mitigations:
- Pattern matches the documented intent in the JSDoc comments
- Implementation matches test expectations (latest listener always called)
- No changes to the public API or behavior - just fixes the missing declaration

---

## Validation Evidence

### Code Quality:
- ✅ TypeScript: No type errors
- ✅ Logic: Ref pattern properly implemented
- ✅ Comments: JSDoc already described this behavior, now it's actually implemented

### Behavior Preservation:
- Hook still subscribes to agentEventBus on mount
- Still unsubscribes on unmount (cleanup)
- Still uses latest listener callback when props change
- Subscription only re-creates when event type changes

---

## Regressions Considered

| Scenario | Risk | Mitigation |
|----------|------|------------|
| Stale closure | None | Ref pattern ensures latest callback |
| Memory leak | None | Unsubscribe cleanup unchanged |
| Extra re-renders | None | Ref update doesn't trigger render |
| Subscription thrashing | None | Effect deps unchanged `[event]` |

---

## Follow-ups

- **T3** (Next): Run full test suite to ensure no regressions
- **T4** (Later): Consider extracting timer orchestration from App.tsx bootstrap
- Consider adding integration test for useAgentEvents with actual event bus

---

## Git Status

Modified: `src/hooks/useAgentEvents.ts`

Pre-existing modified files (unrelated to this task):
- `src/hooks/useTimer.ts` (from T1)
- `src/components/home/ModeCard.tsx`
- `src/navigation/AppNavigator.tsx`
- `src/ui/cosmic/CosmicBackground.tsx`
