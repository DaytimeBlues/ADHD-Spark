# Task Report: T1 — Timer Store Selector Refactor

**Task ID:** T1  
**Date:** 2026-02-26  
**Status:** ✅ Completed  
**Scope:** `spark-adhd/src/hooks/useTimer.ts`

---

## Summary of Changes

Refactored `useTimer` hook to eliminate full-store subscription pattern and replace with granular Zustand selectors.

### Key Changes:
1. **Removed broad store subscription:**
   - Before: `const store = useTimerStore()`
   - After: Individual selectors for each state slice (`activeMode`, `isRunning`, `remainingSeconds`, `completedAt`)

2. **Selected actions separately:**
   - Added stable action selectors: `storeStart`, `storePause`, `storeReset`
   - Zustand action functions are stable references, safe to include in deps

3. **Memoized derived values:**
   - `isActive`, `isRunning`, `timeLeft`, `hasCompleted` now use `useMemo`
   - Prevents reference changes on unrelated store updates

4. **Cleaned up dependency arrays:**
   - Removed `store` object from all callback/effect deps
   - Dependencies now only include primitive values and stable action refs

---

## Rationale

The original implementation subscribed to the entire Zustand store, causing:
- Unnecessary re-renders when any store property changed
- Unstable callback references (store object changes on every render)
- Broad dependency arrays triggering effect re-runs

Per Zustand best practices and the audit findings, granular selectors reduce re-render pressure and improve React reconciliation efficiency.

---

## Files Changed

- `src/hooks/useTimer.ts` (only file modified)

---

## Risk Assessment

**Level:** Low

### Potential Risks:
- Derived value memoization could theoretically miss edge cases
- Action selection pattern relies on Zustand's stable action references

### Mitigations:
- `useMemo` dependencies cover all inputs to derived calculations
- Zustand's `set/get` are stable by design (no re-renders from action changes)
- Timer behavior (start/pause/reset/complete) preserved exactly
- E2E controls (fastForward, complete) unchanged

---

## Validation Evidence

### Commands Run:
```bash
npx eslint src/hooks/useTimer.ts
npx prettier --write src/hooks/useTimer.ts
```

### Results:
- ✅ ESLint: 0 errors, 0 warnings (after prettier fix)
- ✅ Prettier: Applied formatting fixes (3 minor style issues)

### Behavior Preservation:
- Timer start/pause/reset logic unchanged
- Auto-start functionality unchanged
- Completion callback (`onComplete`) unchanged
- E2E test controls unchanged
- Store mutations via `setState` unchanged (only where necessary)

---

## Regressions Considered

| Scenario | Risk | Mitigation |
|----------|------|------------|
| Derived `isActive` stale | Low | `useMemo` with `[activeMode, id]` deps |
| Action reference instability | None | Zustand actions are stable |
| Effect re-run cascade | Low | Removed `store` from all deps |
| Completion timing | None | `completedAt` selector same timing |

---

## Follow-ups

- **T2** (Next): Fix listener dependency safety in `useAgentEvents`
- **T4** (Later): Consider extracting timer orchestration from App.tsx bootstrap
- Consider adding unit tests for `useTimer` hook (currently none)

---

## Git Status

Modified: `src/hooks/useTimer.ts`

Pre-existing modified files (unrelated to this task):
- `src/components/home/ModeCard.tsx`
- `src/navigation/AppNavigator.tsx`
- `src/ui/cosmic/CosmicBackground.tsx`
